upstream auth_service {
    server 172.26.239.102:4200;
}

upstream normal_backend {
    server 172.26.239.102:4200;
}

upstream vip_backend {
    server 172.26.228.52:8080;
}

server {
    listen 80;
    server_name _;

    location /chatify/ {
        # 认证检查
        auth_request /chatify/auth/v1/verifyToken;

        # 从认证服务获取用户信息
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $is_vip $upstream_http_x_user_vip;
        auth_request_set $vip_level $upstream_http_x_vip_level;

        # 根据VIP状态选择后端
        set $backend_group normal_backend;
        if ($is_vip = "true") {
            set $backend_group vip_backend;
        }

        proxy_pass http://$backend_group;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header X-Is-VIP $is_vip;
        proxy_set_header X-VIP-Level $vip_level;
    }

    location = /chatify/auth/v1/verifyToken {
        internal;
        proxy_pass http://auth_service/chatify/auth/v1/verifyToken;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;

        proxy_connect_timeout 2s;
        proxy_read_timeout 3s;
    }
}