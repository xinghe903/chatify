upstream auth_service {
    server 192.168.1.100:8080;
}

upstream normal_backend {
    hash $http_X_User_ID consistent;
    server 192.168.1.100:8081;
}

upstream vip_backend {
    server 192.168.1.100:8091;
}

server {
    listen 80;
    server_name _;

    # location 1: å¤„ç† /chatify/auth/ ä¸‹çš„æ‰€æœ‰è¯·æ±‚ â†’ ç›´æ¥è½¬å‘ç»™ auth_service
    # ä½¿ç”¨ ^~ ä¿®é¥°ç¬¦ï¼šå‰ç¼€åŒ¹é…ä¸”ä¼˜å…ˆäºæ­£åˆ™ï¼Œä¸èµ° auth_request
    location ^~ /chatify/auth/ {
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # location 2: å¤„ç†å…¶ä»– /chatify/ è¯·æ±‚ï¼ˆé /chatify/auth/ï¼‰
    # å¿…é¡»æ”¾åœ¨ /chatify/auth/ ä¹‹åï¼Œç¡®ä¿æ›´é•¿çš„å‰ç¼€ä¼˜å…ˆåŒ¹é…
    location /chatify/ {
        # è®¤è¯æ£€æŸ¥ï¼šè°ƒç”¨è®¤è¯æœåŠ¡éªŒè¯ token
        auth_request /chatify/internal/auth/verify;

        # è·å–è®¤è¯æœåŠ¡è¿”å›çš„ç”¨æˆ·ä¿¡æ¯
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $is_vip $upstream_http_x_user_vip;
        auth_request_set $user_name $upstream_http_x_user_name;
        # æ•è·è®¤è¯å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
        auth_request_set $auth_error $upstream_http_x_auth_error;

        # æ ¹æ® VIP çŠ¶æ€é€‰æ‹©åç«¯
        set $backend_group normal_backend;
        if ($is_vip = "true") {
            set $backend_group vip_backend;
        }

        proxy_pass http://$backend_group;
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Is-VIP $is_vip;
        proxy_set_header X-User-Name $user_name;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- WebSocket æ”¯æŒ ---
        # è¿™ä¸¤ä¸ªå¤´æ˜¯â€œæ¡ä»¶æ€§â€ç”Ÿæ•ˆçš„ï¼š
        # - å¦‚æœå®¢æˆ·ç«¯å‘äº† Upgradeï¼Œåˆ™ Nginx ä¼šå‡çº§åè®®
        # - å¦‚æœæ²¡å‘ï¼Œåˆ™å½“ä½œæ™®é€š HTTP è½¬å‘
        proxy_set_header Upgrade $http_upgrade;      # é€ä¼  Upgrade å¤´
        proxy_set_header Connection "upgrade";       # å‘Šè¯‰åç«¯å‡†å¤‡å‡çº§

        # ğŸ‘‡ å…³é”®ï¼šæ‹¦æˆª auth_request å¤±è´¥æ—¶çš„é”™è¯¯ï¼Œäº¤ç”±è‡ªå®šä¹‰ location å¤„ç†
        error_page 401 = @return_auth_error;
    }

    # å­è¯·æ±‚ï¼šç”¨äº auth_request çš„è®¤è¯éªŒè¯ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
    location = /chatify/internal/auth/verify {
        internal;
        proxy_pass http://auth_service/chatify/auth/v1/verifyToken;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header access-token $http_access_token;

        # ğŸ‘‡ å…è®¸ Nginx æ¥æ”¶è®¤è¯æœåŠ¡è¿”å›çš„å“åº”å¤´
        proxy_intercept_errors on;
        # å¦‚æœè®¤è¯æœåŠ¡è¿”å› 401/403/5xxï¼ŒNginx ä»ä¼šæ¥æ”¶å“åº”ä½“ï¼Œè€Œä¸æ˜¯ç›´æ¥æŠ¥é”™
        
        proxy_connect_timeout 2s;
        proxy_read_timeout 3s;
    }

    # è¿”å›è®¤è¯é”™è¯¯ä¿¡æ¯ï¼ˆä¸é‡æ–°è°ƒç”¨æ¥å£ï¼‰
    location @return_auth_error {
        internal;

        # ä½¿ç”¨ auth_request_set æ•è·çš„é”™è¯¯ä¿¡æ¯
        add_header Content-Type 'application/json; charset=utf-8' always;
        return 401 '{"code":401,"message":"Invalid or expired access token"}';
    }
}
