
## 一、Kafka 消息结构定义（JSON Schema）

### 1. `chat_input` —— 用户聊天输入

| 字段 | 类型 | 必填 | 描述 |
|------|------|-----|------|
| request_id | string | true | 请求ID |
| sender_id | string | true | 发送者ID |
| receiver_id | string | true | 接收者ID |
| content | bytes | true | 消息内容，JSON 字符串格式 |
| message_type | string | true | 消息类型，如：MessageType |

MessageType 枚举定义：
| 枚举值 | 描述 | 
|------|------|
| text | 文本消息 |
| image |  图片消息，base64 编码 |
| file | 文件内容，base64 编码 |
| system | 系统通知 |
| control | 推送控制指令，如：停止推送、重新推送 |
| indicator | 指标信息 |


``` json
{
  "request_id": "req_123",
  "sender_id": "u1001",
  "receiver_id": "u1002",
  "content": "{\"text\": \"Hello\"}",
  "message_type": "text",
  "timestamp": 1732694400
}
```


### 2. `user_state` —— 用户上线下线通知

| 字段 | 类型 | 必填 | 描述 |
|------|------|-----|------|
| user_id | string | true | 用户ID |
| state | string | true | 用户状态，如：online, offline |



``` json
{
  "user_id": "req_123",
  "state": "online",
  "timestamp": 1732694400
}
```


## 二、gRPC 接口定义（Protobuf）

> 使用 Protobuf 定义服务接口

详情见 `/api`。即项目根目录下的 `api` 文件夹


## 三、redis 存储结构定义

### 1. 用户状态

采用 redis hash 存储

| key | field | value | 描述 |
|------|------|------|------|
| chatify:user:{user_id} | node | node_id | 用户节点ID |
| chatify:user:{user_id} | connection_id | connection_id | 用户连接ID |
| chatify:user:{user_id} | status | online | 用户状态 |
| chatify:user:{user_id} | last_active | timestamp | 最后活跃时间 |


## 四、数据库存储结构定义

### 1. 离线消息存储表`chatify_offline_message`
| 字段 | 类型 | 描述 |
|------|------|------|
| message_id | string | 消息ID |
| sender_id | string | 发送者ID |
| receiver_id | string | 接收者ID |
| message | bytes | 原始消息 |
| expire_at | timestamp | 过期时间 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |
| deleted_at | timestamp | 删除时间 |


### 2. 消息存储表`chatify_message`
| 字段 | 类型 | 描述 |
|------|------|------|
| message_id | string | 消息ID |
| message_type | string | 消息类型 |
| from_user_id | string | 发送者ID |
| to_user_id | string | 接收者ID |
| content_id | string | 消息内容ID |
| content | bytes | 消息内容 |
| timestamp | timestamp | 发送时间 |
| expire_at | timestamp | 过期时间 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |
| deleted_at | timestamp | 删除时间 |

## 五、etcd 存储结构定义

| key | value | 描述 |
|------|------|------|
