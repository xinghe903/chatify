http {
    upstream auth_service {
        server 192.168.1.100:8080;
    }
    
    upstream normal_backend {
        server 192.168.1.110:8080;
    }
    
    upstream vip_backend {
        server 192.168.1.120:8080;
    }
    
    server {
        listen 800;
        
        location /api/ {
            # 认证检查
            auth_request /auth/verify;
            
            # 从认证服务获取用户信息
            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $is_vip $upstream_http_x_user_vip;
            auth_request_set $vip_level $upstream_http_x_vip_level;
            
            # 根据VIP状态选择后端
            if ($is_vip = "true") {
                set $backend_group "vip_backend";
            }
            if ($is_vip != "true") {
                set $backend_group "normal_backend";
            }
            
            proxy_pass http://$backend_group;
            proxy_set_header X-User-ID $user_id;
            proxy_set_header X-Is-VIP $is_vip;
            proxy_set_header X-VIP-Level $vip_level;
        }
        
        location = /auth/verify {
            internal;
            proxy_pass http://auth_service/verify;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Authorization $http_authorization;
        }
    }
}